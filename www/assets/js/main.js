(()=>{"use strict";(()=>{function t(t,e,n){const o=new FormData;o.set("city_id",n),o.set("city",t),o.set("region",e),fetch(url_save_to_backend,{method:"POST",credentials:"same-origin",headers:{X_TOBACKEND:"toBackend"},body:o}).then((t=>t.json())).then((t=>{const e=document.getElementById("data_by_location");e&&(e.innerHTML=t)}))}function e({city:t,adress:e}){const n=document.getElementById("location"),o=document.getElementById("clients_location_message"),i=document.getElementById("modal_1");if(n&&t&&"string"==typeof t){n.innerHTML=t;let i="";i="string"==typeof e&&e&&e.includes(t+" ")?'<div class="my2">'+e+"</div>":"string"==typeof e&&e&&!e.includes(t+" ")&&e!=t?'<div class="mt2">'+t+'</div><div class="mb2">'+e+"</div>":'<div class="my2">'+t+".</div>",o.innerHTML="Ваше местоположение: "+i+' Если нет - выберите его, нажав на кнопку "Выбрать"'}n&&!t&&o&&(o.innerHTML='Ваше местоположение неизвестно. </br>Выберите его, нажав на кнопку "Выбрать"',i.checked=!0)}function n(t){let e=localStorage.getItem(t);return null!=e&&JSON.parse(e)}function o({city:t,adress:e="",id:n=""}){let o={city:t,adress:e,id:n};localStorage.setItem("locality",JSON.stringify(o))}const i=t=>"string"==typeof t?document.querySelector(t):t(),s=(t,e)=>{const n="string"==typeof t?document.createElement(t):t;for(const t in e){const o=e[t];if("inside"===t)o.append(n);else if("dest"===t)i(o[0]).insertAdjacentElement(o[1],n);else if("around"===t){const t=o;t.parentNode.insertBefore(n,t),n.append(t),null!=t.getAttribute("autofocus")&&t.focus()}else t in n?n[t]=o:n.setAttribute(t,o)}return n},c=(t,e)=>(t=String(t).toLowerCase(),e?t.normalize("NFD").replace(/[\u0300-\u036f]/g,"").normalize("NFC"):t),r=(t,e)=>s("mark",{innerHTML:t,..."string"==typeof e&&{class:e}}).outerHTML,l=(t,e)=>{e.input.dispatchEvent(new CustomEvent(t,{bubbles:!0,detail:e.feedback,cancelable:!0}))},a=(t,e,n)=>{const{mode:o,diacritics:i,highlight:s}=n||{},l=c(e,i);if(e=String(e),t=c(t,i),"loose"===o){const n=(t=t.replace(/ /g,"")).length;let o=0;const i=Array.from(e).map(((e,i)=>(o<n&&l[i]===t[o]&&(e=s?r(e,s):e,o++),e))).join("");if(o===n)return i}else{let n=l.indexOf(t);if(~n)return t=e.substring(n,n+t.length),n=s?e.replace(t,r(t,s)):e,n}},d=async(t,e)=>{const{data:n}=t;n.cache&&n.store||(t.feedback=n.store="function"==typeof n.src?"AsyncFunction"===n.src.constructor.name?await n.src(e):n.src(e):n.src,l("response",t))},u="aria-expanded",p="aria-activedescendant",f="aria-selected",m=(t,e)=>{t.feedback.selection={index:e,...t.feedback.results[e]}},h=t=>{t.isOpen||((t.wrapper||t.input).setAttribute(u,!0),t.list.removeAttribute("hidden"),t.isOpen=!0,l("open",t))},y=t=>{t.isOpen&&((t.wrapper||t.input).setAttribute(u,!1),t.input.setAttribute(p,""),t.list.setAttribute("hidden",""),t.isOpen=!1,l("close",t))},g=(t,e)=>{const{resultItem:n}=e,o=e.list.getElementsByTagName(n.tag),i=!!n.selected&&n.selected.split(" ");if(e.isOpen&&o.length){const n=e.cursor;t>=o.length&&(t=0),t<0&&(t=o.length-1),e.cursor=t,n>-1&&(o[n].removeAttribute(f),i&&o[n].classList.remove(...i)),o[t].setAttribute(f,!0),i&&o[t].classList.add(...i),e.input.setAttribute(p,o[e.cursor].id),e.list.scrollTop=o[t].offsetTop-e.list.clientHeight+o[t].clientHeight+5,e.feedback.cursor=e.cursor,m(e,t),l("navigate",e)}},v=t=>{g(t.cursor+1,t)},b=t=>{g(t.cursor-1,t)},_=(t,e,n)=>{(n=n>=0?n:t.cursor)<0||(t.feedback.event=e,m(t,n),l("selection",t),y(t))};async function L(t,e){let n=e||((o=t.input)instanceof HTMLInputElement||o instanceof HTMLTextAreaElement?o.value:o.innerHTML);var o;n=t.query?t.query(n):n;if(((t,e,n)=>e?e(t):t.length>=n)(n,t.trigger,t.threshold)){if(await d(t,n),t.feedback instanceof Error)return;((t,e)=>{const{data:n,searchEngine:o}=e;let i=[];n.store.forEach(((s,c)=>{const r=n=>{const c=n?s[n]:s,r="function"==typeof o?o(t,c):a(t,c,{mode:o,diacritics:e.diacritics,highlight:e.resultItem.highlight});if(!r)return;let l={match:r,value:s};n&&(l.key=n),i.push(l)};if(n.keys)for(const t of n.keys)r(t);else r()})),n.filter&&(i=n.filter(i));const s=i.slice(0,e.resultsList.maxResults);e.feedback={query:t,matches:i,results:s},l("results",e)})(n,t),t.resultsList&&(t=>{const{resultsList:e,list:n,resultItem:o,feedback:i}=t,{matches:c,results:r}=i;if(t.cursor=-1,n.innerHTML="",c.length||e.noResults){const c=new DocumentFragment;r.forEach(((t,e)=>{const n=s(o.tag,{id:`${o.id}_${e}`,role:"option",innerHTML:t.match,inside:c,...o.class&&{class:o.class}});o.element&&o.element(n,t)})),n.append(c),e.element&&e.element(n,i),h(t)}else y(t)})(t)}else y(t)}const E=(t,e)=>{for(const n in t)for(const o in t[n])e(n,o)},k=t=>{const{events:e}=t,n=((t,e)=>{let n;return()=>{clearTimeout(n),n=setTimeout((()=>t()),e)}})((()=>L(t)),t.debounce),o=t.events={input:{...e&&e.input},...t.resultsList&&{list:e?{...e.list}:{}}},i={input:{input(){n()},keydown(e){((t,e)=>{switch(t.keyCode){case 40:case 38:t.preventDefault(),40===t.keyCode?v(e):b(e);break;case 13:e.submit||t.preventDefault(),e.cursor>=0&&_(e,t);break;case 9:e.resultsList.tabSelect&&e.cursor>=0&&_(e,t);break;case 27:e.input.value="",l("clear",e),y(e)}})(e,t)},blur(){y(t)}},list:{mousedown(t){t.preventDefault()},click(e){((t,e)=>{const n=e.resultItem.tag.toUpperCase(),o=Array.from(e.list.querySelectorAll(n)),i=t.target.closest(n);i&&i.nodeName===n&&_(e,t,o.indexOf(i))})(e,t)}}};E(i,((e,n)=>{(t.resultsList||"input"===n)&&(o[e][n]||(o[e][n]=i[e][n]))})),E(o,((e,n)=>{t[e].addEventListener(n,o[e][n])}))};async function T(t){const{placeHolder:e,resultsList:n}=t,o={role:"combobox","aria-owns":n.id,"aria-haspopup":!0,"aria-expanded":!1};s(t.input,{"aria-controls":n.id,"aria-autocomplete":"both",...e&&{placeholder:e},...!t.wrapper&&{...o}}),t.wrapper&&(t.wrapper=s("div",{around:t.input,class:t.name+"_wrapper",...o})),n&&(t.list=s(n.tag,{dest:[n.destination,n.position],id:n.id,role:"listbox",hidden:"hidden",...n.class&&{class:n.class}})),k(t),t.data.cache&&await d(t),l("init",t)}function w(t){const{prototype:e}=t;e.init=function(){T(this)},e.start=function(t){L(this,t)},e.unInit=function(){if(this.wrapper){const t=this.wrapper.parentNode;t.insertBefore(this.input,this.wrapper),t.removeChild(this.wrapper)}var t;E((t=this).events,((e,n)=>{t[e].removeEventListener(n,t.events[e][n])}))},e.open=function(){h(this)},e.close=function(){y(this)},e.goTo=function(t){g(t,this)},e.next=function(){v(this)},e.previous=function(){b(this)},e.select=function(t){_(this,null,t)},e.search=function(t,e,n){return a(t,e,n)}}function S(t){this.options=t,this.id=S.instances=(S.instances||0)+1,this.name="autoComplete",this.wrapper=1,this.threshold=1,this.debounce=0,this.resultsList={position:"afterend",tag:"ul",maxResults:5},this.resultItem={tag:"li"},(t=>{const{name:e,options:n,resultsList:o,resultItem:s}=t;for(const e in n)if("object"==typeof n[e]){t[e]||(t[e]={});for(const o in n[e])t[e][o]=n[e][o]}else t[e]=n[e];t.selector=t.selector||"#"+e,o.destination=o.destination||t.selector,o.id=o.id||e+"_list_"+t.id,s.id=s.id||e+"_result",t.input=i(t.selector)})(this),w.call(this,S),T(this)}function I(t){const e=document.getElementById(t);e&&(e.checked=!1)}function A(t){let e=document.querySelector("#shoose_district");e&&e.addEventListener("change",(function(){let e=document.querySelector("#empty_district");e&&e.remove();let n=this.value;this.options[this.selectedIndex].text;if(n){let e=t[n];if(e){let t=e.regions;!function(t){let e='<option value="" id="empty_region">Регион</option>';for(const n of Object.keys(t))e=e+'<option value="'+t[n].id+'">'+t[n].name+"</option>";let n=document.querySelector("#shoose_region");n&&(n.disabled=!1,n.innerHTML=e);let o=document.querySelector("#shoose_city");o&&(o.innerHTML='<option value="">Город</option>')}(t),function(t){let e=document.querySelector("#shoose_region");e&&e.addEventListener("change",(function(){let e=document.querySelector("#empty_region");e&&e.remove();let n=this.value,o=this.options[this.selectedIndex].text;if(n){let e=t[n];if(e){let t=e.cities;t&&function(t){let e='<option value="" id="empty_city">Город</option>';for(const n of Object.keys(t))e=e+'<option value="'+t[n].id+'">'+t[n].name+"</option>";let n=document.querySelector("#shoose_city");n&&(n.disabled=!1,n.innerHTML=e)}(t)}let i=document.querySelector("#shoose_city");i&&i.addEventListener("change",(function(){let t=document.querySelector("#empty_city");t&&t.remove();let e=this.value;O(this.options[this.selectedIndex].text,o,e)}))}}))}(t)}}}))}function O(n,i,s){let c=document.querySelector("#save_city");c&&c.addEventListener(function(){const t=navigator.userAgent.toLowerCase().match(/mobile/i),e=navigator.userAgent.toLowerCase().match(/tablet/i),n=navigator.userAgent.toLowerCase().match(/android/i),o=navigator.userAgent.toLowerCase().match(/iphone/i),i=navigator.userAgent.toLowerCase().match(/ipad/i);return t||e||n||o||i?"touchstart":"click"}(),function(n,i,s){let c=i;o({city:n,adress:c,id:s}),e({city:n,adress:c}),t(n,i,s);const r=document.getElementById("show_city_select");r&&(r.checked=!1)}(n,i,s))}function M(t){let e=t.district,n=[];for(let t of Object.keys(e))for(let o of Object.keys(e[t].regions))for(let i of Object.keys(e[t].regions[o].cities)){let s=e[t].regions[o].name,c=e[t].regions[o].cities[i].name,r=e[t].regions[o].cities[i].id;n.push({id:r,city:c,region:s})}return n}function H(t){let e=t.district;!function(t){let e='<option value="" id="empty_district">Округ</option>';for(const n of Object.keys(t))e=e+'<option value="'+t[n].id+'">'+t[n].name+"</option>";let n=document.querySelector("#shoose_district");n&&(n.innerHTML=e);let o=document.querySelector("#shoose_region");o&&(o.innerHTML='<option value="">Регион</option>');let i=document.querySelector("#shoose_city");i&&(i.innerHTML='<option value="">Город</option>')}(e),A(e),function(t){new S({selector:"#autoComplete",placeHolder:"Поиск...",data:{src:M(t),keys:["city"],cache:!0},threshold:3,debounce:300,searchEngine:"strict",resultsList:{element:(t,e)=>{if(!e.results.length){const n=document.createElement("div");n.setAttribute("class","no_result"),n.style.padding="1rem",n.innerHTML="<span>Не найдено "+function(t){const e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"};return t.replace(/[&<>"'/]/gi,(t=>e[t]))}(e.query)+"</span>",t.prepend(n)}},noResults:!0},resultItem:{highlight:!0}}),document.querySelector("#autoComplete").addEventListener("selection",(function(t){let e=t.detail.selection.value;document.querySelector("#autoComplete").value="",O(e.city,e.region,e.id)}))}(t)}function q(){fetch(url_from_db,{method:"POST",credentials:"same-origin",headers:{Accept:"application/json",X_FROMDB:"shooseFromDb"}}).then((t=>!0===t.ok&&t.json())).then((t=>{var e;e=t,localStorage.setItem("all_locality",JSON.stringify(e)),H(t)}))}!function(){function t(t,e){let n=document.getElementById(t);n&&(n.innerHTML=e)}document.addEventListener("DOMContentLoaded",(function(){!function(t){const e=document.getElementById(t);e&&(e.checked=!1)}("modal_1"),t("footer_city_message",'<label for="show_city_select" class="button" id="shoose_location">\t\t\t\t\t\tВыбрать\t\t\t\t\t</label>\t\t\t\t\t<label for="modal_1" class="button dangerous">\t\t\t\t\t\tЗакрыть\t\t\t\t\t</label>'),t("section_city_choice",'<p>По названию:</p>\t\t\t\t<input class="" name="city_search_input" id="autoComplete" type="search" dir="ltr" spellcheck=false autocorrect="off" autocomplete="off" autocapitalize="off" maxlength="2048" tabindex="1">\t\t\t\t<p>Или из списка:</p>\t\t\t\t<select id="shoose_district" class=" select mb1">\t\t\t\t\t<option>Округ</option>\t\t\t\t</select>\t\t\t\t<select id="shoose_region" class=" select mb1" disabled>\t\t\t\t\t<option>Регион (область)</option>\t\t\t\t</select>\t\t\t\t<select id="shoose_city" class=" select" disabled>\t\t\t\t\t<option>Город</option>\t\t\t\t</select>'),t("footer_city_choice",'<button id="save_city" class="button">\t\t\t\t\t\t\t\t\tВыбрать\t\t\t\t\t\t\t\t</button>\t\t\t\t\t\t\t\t<label for="show_city_select" class="button dangerous">\t\t\t\t\t\t\t\t\tЗакрыть\t\t\t\t\t\t\t\t</label>')}))}(),setTimeout(void document.addEventListener("DOMContentLoaded",(()=>{let i=n("locality");const s=document.getElementById("location");let c="";if(s&&(c=s.innerHTML),i){if(e({city:i.city,adress:i.adress}),c&&!c.includes(i.city)){let e="";i.id&&(e=i.id),t(i.city,i.adress,e)}}else if(c)if(c.includes("Местоположение"))!async function(){function n({city:n,adress:i,id:s}){e({city:n,adress:i}),o({city:n,adress:i,id:s}),t(n,i,s)}let i={timeout:5e3};async function s(t){const e=t.coords.latitude;let o=t.coords.longitude,i=e,s=await fetch(url_from_coord+"?coord="+o+"_"+i,{credentials:"same-origin",headers:{Accept:"application/json"}});const c=await s.json();try{"object"==typeof(r=c)&&"city"in r&&""!=r.city&&"undefined"!=r.city&&"string"==typeof r.city?n(c):n({city:"",adress:""})}catch(t){n({city:"",adress:""})}var r}function c(t){switch(e({city:"",adress:""}),t.code){case t.PERMISSION_DENIED:case t.POSITION_UNAVAILABLE:case t.TIMEOUT:case t.UNKNOWN_ERROR:}}!async function(){navigator.geolocation?navigator.geolocation.getCurrentPosition(s,c,i):e({city:"",adress:""})}()}();else{const t=document.getElementById("p_city");let n="";t&&(n=t.innerHTML);const i=document.getElementById("p_region");let s="";i&&(s=i.innerHTML),e({city:c,adress:s}),o({city:c,adress:s})}})),100),setTimeout(void document.addEventListener("DOMContentLoaded",(function(){const t=document.querySelector("#shoose_location");if(t){function e(){let t=n("all_locality");t?H(t):q()}t.addEventListener("click",(function(){I("modal_1"),e()}),!1),t.addEventListener("touchstart",(function(){I("modal_1"),e()}),!1)}})),1e3),document.onkeydown=function(t){if("Escape"==t.key){var e=document.querySelectorAll(".modal > [type=checkbox]");[].forEach.call(e,(function(t){t.checked=!1}))}},document.onkeydown=function(t){if("Escape"==t.key){var e=document.querySelectorAll(".modal > [type=checkbox]");[].forEach.call(e,(function(t){t.checked=!1}))}}})()})();