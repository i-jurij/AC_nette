(()=>{"use strict";function t(t,e){let o=document.getElementById(t);o&&(o.checked="show"==e)}function e(t,e){let o=document.getElementById(t);o&&(o.innerHTML=e)}function o({city:o,region:i}){let s="";o&&"string"==typeof o?(s="Ваше местоположение: "+function(t,e){let o="";return o="string"==typeof e&&e&&e.includes(t+" ")?'<div class="my2">'+e+"</div>":"string"==typeof e&&e&&!e.includes(t+" ")&&e!=t?'<div class="mt2">'+t+'</div><div class="mb2">'+e+"</div>":'<div class="my2">'+t+".</div>",o}(o,i)+' Если нет - выберите его, нажав на кнопку "Выбрать"',e("location",o),e("clients_location_message",s)):(s='Ваше местоположение неизвестно. </br>Выберите его, нажав на кнопку "Выбрать"',e("clients_location_message",s),t("modal_1","hide"))}function i(o){let i=o.district;!function(t){let o='<option value="" id="empty_district">Округ</option>';for(const e of Object.keys(t))o=o+'<option value="'+t[e].id+'">'+t[e].name+"</option>";e("shoose_district",o),e("shoose_region",'<option value="">Регион</option>'),e("shoose_city",'<option value="">Город</option>')}(i),function(t){let e=document.querySelector("#shoose_district");e&&e.addEventListener("change",(function(){let e=document.querySelector("#empty_district");e&&e.remove();let o=this.value;this.options[this.selectedIndex].text;if(o){let e=t[o];if(e){let t=e.regions;!function(t){let e='<option value="" id="empty_region">Регион</option>';for(const o of Object.keys(t))e=e+'<option value="'+t[o].id+'">'+t[o].name+"</option>";let o=document.querySelector("#shoose_region");o&&(o.disabled=!1,o.innerHTML=e);let i=document.querySelector("#shoose_city");i&&(i.innerHTML='<option value="">Город</option>')}(t),function(t){let e=document.querySelector("#shoose_region"),o=document.querySelector("#shoose_city");e&&e.addEventListener("change",(function(){let e=document.querySelector("#empty_region");e&&e.remove();let i=this.value;this.options[this.selectedIndex].text;if(i){let e=t[i];if(e){let t=e.cities;if(t){let e='<option value="" id="empty_city">Город</option>';for(const o of Object.keys(t))e=e+'<option value="'+t[o].id+'">'+t[o].name+"</option>";o&&(o.disabled=!1,o.innerHTML=e)}}o&&o.addEventListener("change",(function(){let t=document.querySelector("#empty_city");t&&t.remove();this.options[this.selectedIndex].text}))}}))}(t)}}}))}(i),t("show_city_select","show"),t("modal_1","hide")}class s{getFromLocalStorage(t){let e=localStorage.getItem(t);return null!=e?JSON.parse(e):null}setLocalityToLocalStorage({city:t,region:e=""}){let o={city:t,region:e};localStorage.setItem("locality",JSON.stringify(o))}removeLocalityFromLocalStorage(){localStorage.removeItem("locality")}setAllLocalityFromDBToLocalStorage(t){localStorage.setItem("all_locality",JSON.stringify(t))}}class n{url="";type="";async get(){let t=await this.getCoords();if(t){this.type="db";let e=await this.fetchCoord(t);return!1===this.checkResponce(await e)&&(this.type="yg",e=await this.fetchCoord(t),!1===this.checkResponce(await e)&&(e={city:"",region:""})),await e}}async getCoords(){const t=await new Promise(((t,e)=>{navigator.geolocation.getCurrentPosition(t,(function(t){}),{maximumAge:36e5})}));return{long:t.coords.longitude,lat:t.coords.latitude}}async fetchCoord(t){let e="?long="+t.long+"&lat="+t.lat,o="&token="+csrf,i="&"+this.type+"="+this.type;const s=await fetch(this.url+e+i+o,{credentials:"same-origin",headers:{Accept:"application/json"}});return await s.json()}checkResponce(t){return"object"==typeof t&&"city"in t&&""!=t.city&&"undefined"!=t.city&&"string"==typeof t.city}}const c=t=>"string"==typeof t?document.querySelector(t):t(),r=(t,e)=>{const o="string"==typeof t?document.createElement(t):t;for(const t in e){const i=e[t];if("inside"===t)i.append(o);else if("dest"===t)c(i[0]).insertAdjacentElement(i[1],o);else if("around"===t){const t=i;t.parentNode.insertBefore(o,t),o.append(t),null!=t.getAttribute("autofocus")&&t.focus()}else t in o?o[t]=i:o.setAttribute(t,i)}return o},l=(t,e)=>(t=String(t).toLowerCase(),e?t.normalize("NFD").replace(/[\u0300-\u036f]/g,"").normalize("NFC"):t),a=(t,e)=>r("mark",{innerHTML:t,..."string"==typeof e&&{class:e}}).outerHTML,u=(t,e)=>{e.input.dispatchEvent(new CustomEvent(t,{bubbles:!0,detail:e.feedback,cancelable:!0}))},d=(t,e,o)=>{const{mode:i,diacritics:s,highlight:n}=o||{},c=l(e,s);if(e=String(e),t=l(t,s),"loose"===i){const o=(t=t.replace(/ /g,"")).length;let i=0;const s=Array.from(e).map(((e,s)=>(i<o&&c[s]===t[i]&&(e=n?a(e,n):e,i++),e))).join("");if(i===o)return s}else{let o=c.indexOf(t);if(~o)return t=e.substring(o,o+t.length),o=n?e.replace(t,a(t,n)):e,o}},h=async(t,e)=>{const{data:o}=t;o.cache&&o.store||(t.feedback=o.store="function"==typeof o.src?"AsyncFunction"===o.src.constructor.name?await o.src(e):o.src(e):o.src,u("response",t))},p="aria-expanded",f="aria-activedescendant",m="aria-selected",y=(t,e)=>{t.feedback.selection={index:e,...t.feedback.results[e]}},g=t=>{t.isOpen||((t.wrapper||t.input).setAttribute(p,!0),t.list.removeAttribute("hidden"),t.isOpen=!0,u("open",t))},_=t=>{t.isOpen&&((t.wrapper||t.input).setAttribute(p,!1),t.input.setAttribute(f,""),t.list.setAttribute("hidden",""),t.isOpen=!1,u("close",t))},b=(t,e)=>{const{resultItem:o}=e,i=e.list.getElementsByTagName(o.tag),s=!!o.selected&&o.selected.split(" ");if(e.isOpen&&i.length){const o=e.cursor;t>=i.length&&(t=0),t<0&&(t=i.length-1),e.cursor=t,o>-1&&(i[o].removeAttribute(m),s&&i[o].classList.remove(...s)),i[t].setAttribute(m,!0),s&&i[t].classList.add(...s),e.input.setAttribute(f,i[e.cursor].id),e.list.scrollTop=i[t].offsetTop-e.list.clientHeight+i[t].clientHeight+5,e.feedback.cursor=e.cursor,y(e,t),u("navigate",e)}},v=t=>{b(t.cursor+1,t)},L=t=>{b(t.cursor-1,t)},w=(t,e,o)=>{(o=o>=0?o:t.cursor)<0||(t.feedback.event=e,y(t,o),u("selection",t),_(t))};async function S(t,e){let o=e||((i=t.input)instanceof HTMLInputElement||i instanceof HTMLTextAreaElement?i.value:i.innerHTML);var i;o=t.query?t.query(o):o;if(((t,e,o)=>e?e(t):t.length>=o)(o,t.trigger,t.threshold)){if(await h(t,o),t.feedback instanceof Error)return;((t,e)=>{const{data:o,searchEngine:i}=e;let s=[];o.store.forEach(((n,c)=>{const r=o=>{const c=o?n[o]:n,r="function"==typeof i?i(t,c):d(t,c,{mode:i,diacritics:e.diacritics,highlight:e.resultItem.highlight});if(!r)return;let l={match:r,value:n};o&&(l.key=o),s.push(l)};if(o.keys)for(const t of o.keys)r(t);else r()})),o.filter&&(s=o.filter(s));const n=s.slice(0,e.resultsList.maxResults);e.feedback={query:t,matches:s,results:n},u("results",e)})(o,t),t.resultsList&&(t=>{const{resultsList:e,list:o,resultItem:i,feedback:s}=t,{matches:n,results:c}=s;if(t.cursor=-1,o.innerHTML="",n.length||e.noResults){const n=new DocumentFragment;c.forEach(((t,e)=>{const o=r(i.tag,{id:`${i.id}_${e}`,role:"option",innerHTML:t.match,inside:n,...i.class&&{class:i.class}});i.element&&i.element(o,t)})),o.append(n),e.element&&e.element(o,s),g(t)}else _(t)})(t)}else _(t)}const k=(t,e)=>{for(const o in t)for(const i in t[o])e(o,i)},A=t=>{const{events:e}=t,o=((t,e)=>{let o;return()=>{clearTimeout(o),o=setTimeout((()=>t()),e)}})((()=>S(t)),t.debounce),i=t.events={input:{...e&&e.input},...t.resultsList&&{list:e?{...e.list}:{}}},s={input:{input(){o()},keydown(e){((t,e)=>{switch(t.keyCode){case 40:case 38:t.preventDefault(),40===t.keyCode?v(e):L(e);break;case 13:e.submit||t.preventDefault(),e.cursor>=0&&w(e,t);break;case 9:e.resultsList.tabSelect&&e.cursor>=0&&w(e,t);break;case 27:e.input.value="",u("clear",e),_(e)}})(e,t)},blur(){_(t)}},list:{mousedown(t){t.preventDefault()},click(e){((t,e)=>{const o=e.resultItem.tag.toUpperCase(),i=Array.from(e.list.querySelectorAll(o)),s=t.target.closest(o);s&&s.nodeName===o&&w(e,t,i.indexOf(s))})(e,t)}}};k(s,((e,o)=>{(t.resultsList||"input"===o)&&(i[e][o]||(i[e][o]=s[e][o]))})),k(i,((e,o)=>{t[e].addEventListener(o,i[e][o])}))};async function T(t){const{placeHolder:e,resultsList:o}=t,i={role:"combobox","aria-owns":o.id,"aria-haspopup":!0,"aria-expanded":!1};r(t.input,{"aria-controls":o.id,"aria-autocomplete":"both",...e&&{placeholder:e},...!t.wrapper&&{...i}}),t.wrapper&&(t.wrapper=r("div",{around:t.input,class:t.name+"_wrapper",...i})),o&&(t.list=r(o.tag,{dest:[o.destination,o.position],id:o.id,role:"listbox",hidden:"hidden",...o.class&&{class:o.class}})),A(t),t.data.cache&&await h(t),u("init",t)}function C(t){const{prototype:e}=t;e.init=function(){T(this)},e.start=function(t){S(this,t)},e.unInit=function(){if(this.wrapper){const t=this.wrapper.parentNode;t.insertBefore(this.input,this.wrapper),t.removeChild(this.wrapper)}var t;k((t=this).events,((e,o)=>{t[e].removeEventListener(o,t.events[e][o])}))},e.open=function(){g(this)},e.close=function(){_(this)},e.goTo=function(t){b(t,this)},e.next=function(){v(this)},e.previous=function(){L(this)},e.select=function(t){w(this,null,t)},e.search=function(t,e,o){return d(t,e,o)}}function E(t){this.options=t,this.id=E.instances=(E.instances||0)+1,this.name="autoComplete",this.wrapper=1,this.threshold=1,this.debounce=0,this.resultsList={position:"afterend",tag:"ul",maxResults:5},this.resultItem={tag:"li"},(t=>{const{name:e,options:o,resultsList:i,resultItem:s}=t;for(const e in o)if("object"==typeof o[e]){t[e]||(t[e]={});for(const i in o[e])t[e][i]=o[e][i]}else t[e]=o[e];t.selector=t.selector||"#"+e,i.destination=i.destination||t.selector,i.id=i.id||e+"_list_"+t.id,s.id=s.id||e+"_result",t.input=c(t.selector)})(this),C.call(this,E),T(this)}class x{constructor(){this.LS=new s;let t=this.LS.getFromLocalStorage("locality");this.l=t??{city:"",region:""}}async init(){t("modal_1","hide"),e("footer_city_message",'<label for="show_city_select" class="button" id="shoose_location">\t\t\t\t\t\tВыбрать\t\t\t\t\t</label>\t\t\t\t\t<label for="modal_1" class="button dangerous">\t\t\t\t\t\tЗакрыть\t\t\t\t\t</label>'),e("section_city_choice",'<p>По названию:</p>\t\t\t\t<input class="" name="city_search_input" id="autoComplete" type="search" dir="ltr" spellcheck=false autocorrect="off" autocomplete="off" autocapitalize="off" maxlength="2048" tabindex="1">\t\t\t\t<p>Или из списка:</p>\t\t\t\t<select id="shoose_district" class=" select mb1">\t\t\t\t\t<option>Округ</option>\t\t\t\t</select>\t\t\t\t<select id="shoose_region" class=" select mb1" disabled>\t\t\t\t\t<option>Регион (область)</option>\t\t\t\t</select>\t\t\t\t<select id="shoose_city" class=" select" disabled>\t\t\t\t\t<option>Город</option>\t\t\t\t</select>'),e("footer_city_choice",'<button id="save_city" class="button">\t\t\t\t\t\t\t\t\tВыбрать\t\t\t\t\t\t\t\t</button>\t\t\t\t\t\t\t\t<label for="show_city_select" class="button dangerous">\t\t\t\t\t\t\t\t\tЗакрыть\t\t\t\t\t\t\t\t</label>'),document.onkeydown=function(t){if("Escape"==t.key){var e=document.querySelectorAll(".modal > [type=checkbox]");[].forEach.call(e,(function(t){t.checked=!1}))}},this.fromDB(),this.l.city?city_from_back&&!city_from_back.toLowerCase().includes(this.l.city.toLowerCase())&&(this.localityToServer(url_location_to_server_js,csrf,this.l.city,this.l.region),o({city:this.l.city,region:this.l.region})):city_from_back==unknown_location?await this.fromCoord():this.LS.setLocalityToLocalStorage({city:city_from_back,region:region_from_back})}async fromCoord(){this.LC=new n,this.LC.url=url_js_fetch,this.l=await this.LC.get(),this.LC.checkResponce(this.l)&&this.localitySaveAndShow(url_location_to_server_js,csrf,this.l.city,this.l.region)}fromDB(){let t=document.querySelector("#shoose_location");t&&(t.onpointerdown=async()=>{let t=await this.getAllLocations();i(await t),this.autoComplete(await t);let e=document.querySelector("#save_city"),o=document.getElementById("show_city_select"),s=document.querySelector("#shoose_region"),n=document.querySelector("#shoose_city");e&&e.addEventListener("pointerdown",(()=>{let t=s.options[s.selectedIndex].text,e=n.options[n.selectedIndex].text;e&&t&&(this.localitySaveAndShow(url_location_to_server_js,csrf,e,t),o&&(o.checked=!1))}))})}async getAllLocations(){let t=this.LS.getFromLocalStorage("all_locality");return null===t&&(t=await this.getAllLocationsFromDb(),this.LS.setAllLocalityFromDBToLocalStorage(await t)),await t}async getAllLocationsFromDb(){const t=new FormData;t.set("token",csrf),t.set("all_loc","fromdb");const e=await fetch(url_js_fetch,{method:"POST",credentials:"same-origin",headers:{Accept:"application/json",X_FROMDB:"shooseFromDb"},body:t});return await e.json()}localityToServer(t,e,o,i){const s=new FormData;s.set("token",e),s.set("city",o),s.set("region",i),s.set("js","js"),fetch(t,{method:"POST",credentials:"same-origin",headers:{X_TOBACKEND:"tobackend"},body:s}).then((t=>t.json())).then((t=>{const e=document.getElementById("data_by_location");e&&(e.innerHTML=t)}))}autoComplete(t){let e={selector:"#autoComplete",placeHolder:"Поиск...",data:{src:function(t){let e=t.district,o=[];for(let t of Object.keys(e))for(let i of Object.keys(e[t].regions))for(let s of Object.keys(e[t].regions[i].cities)){let n=e[t].regions[i].name,c=e[t].regions[i].cities[s].name,r=e[t].regions[i].cities[s].id;o.push({id:r,city:c,region:n})}return o}(t),keys:["city"],cache:!0},threshold:3,debounce:300,searchEngine:"strict",resultsList:{element:(t,e)=>{if(!e.results.length){const o=document.createElement("div");o.setAttribute("class","no_result"),o.style.padding="1rem",o.innerHTML="<span>Не найдено "+function(t){if(/^[\p{L}\p{N}\s?\-?]+[\s]?[\(]+[\p{L}\p{N}\s?\-?]+[\)]+$/.test(t))return t;{let e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"},o=/[&<>"'/]/gi;return t.replace(o,(t=>e[t]))}}(e.query)+"</span>",t.prepend(o)}},noResults:!0},resultItem:{highlight:!0}};new E(e);document.querySelector("#autoComplete").addEventListener("selection",(t=>{let e=t.detail.selection.value;document.querySelector("#autoComplete").value="",this.localitySaveAndShow(url_location_to_server_js,csrf,e.city,e.region),show_city_select&&(show_city_select.checked=!1)}))}localitySaveAndShow(t,e,i,s){this.LS.setLocalityToLocalStorage({city:i,region:s}),this.localityToServer(t,e,i,s),o({city:i,region:s})}}document.addEventListener("DOMContentLoaded",(()=>{(new x).init()}))})();